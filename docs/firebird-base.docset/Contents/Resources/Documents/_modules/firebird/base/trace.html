<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>firebird.base.trace &#8212; Firebird-base 1.6.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-sphinx.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/fb-favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../../_static/bootstrap-2.3.2/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>

  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>

        <a class="brand" href="../../../index.html">
          Firebird-base</a>
        <span class="navbar-text pull-left"><b>1.6.1</b></span>

        <div class="nav-collapse">
          <ul class="nav">
            <li class="divider-vertical"></li>
            
                <li><a href="../../../introduction.html">Introduction</a></li>
                <li><a href="../../../modules.html">Modules</a></li>
                <li><a href="../../../genindex.html">Index</a></li>
                <li><a href="../../../changelog.html">Changelog</a></li>
                <li><a href="../../../license.html">License</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
      </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body span12 content" role="main">
      
  <h1>Source code for firebird.base.trace</h1><div class="highlight"><pre>
<span></span><span class="c1">#coding:utf-8</span>
<span class="c1">#</span>
<span class="c1"># PROGRAM/MODULE: firebird-base</span>
<span class="c1"># FILE:           firebird/base/trace.py</span>
<span class="c1"># DESCRIPTION:    Trace/audit for class instances</span>
<span class="c1"># CREATED:        5.6.2020</span>
<span class="c1">#</span>
<span class="c1"># The contents of this file are subject to the MIT License</span>
<span class="c1">#</span>
<span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="c1"># in the Software without restriction, including without limitation the rights</span>
<span class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="c1"># copies of the Software, and to permit persons to whom the Software is</span>
<span class="c1"># furnished to do so, subject to the following conditions:</span>
<span class="c1">#</span>
<span class="c1"># The above copyright notice and this permission notice shall be included in all</span>
<span class="c1"># copies or substantial portions of the Software.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="c1"># SOFTWARE.</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2020 Firebird Project (www.firebirdsql.org)</span>
<span class="c1"># All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1"># Contributor(s): Pavel Císař (original code)</span>
<span class="c1">#                 ______________________________________</span>

<span class="sd">&quot;&quot;&quot;firebird-base - Trace/audit for class instances</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Hashable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">signature</span><span class="p">,</span> <span class="n">Signature</span><span class="p">,</span> <span class="n">isfunction</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">IntFlag</span><span class="p">,</span> <span class="n">auto</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span><span class="p">,</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">monotonic</span>
<span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span> <span class="nn">configparser</span> <span class="kn">import</span> <span class="n">ConfigParser</span>
<span class="kn">from</span> <span class="nn">.types</span> <span class="kn">import</span> <span class="n">Error</span><span class="p">,</span> <span class="n">Distinct</span><span class="p">,</span> <span class="n">DEFAULT</span><span class="p">,</span> <span class="n">UNLIMITED</span><span class="p">,</span> <span class="n">load</span>
<span class="kn">from</span> <span class="nn">.collections</span> <span class="kn">import</span> <span class="n">Registry</span>
<span class="kn">from</span> <span class="nn">.strconv</span> <span class="kn">import</span> <span class="n">convert_from_str</span>
<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">StrOption</span><span class="p">,</span> <span class="n">IntOption</span><span class="p">,</span> <span class="n">BoolOption</span><span class="p">,</span> <span class="n">ListOption</span><span class="p">,</span> <span class="n">FlagOption</span><span class="p">,</span> <span class="n">EnumOption</span><span class="p">,</span> \
     <span class="n">ConfigListOption</span><span class="p">,</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">.logging</span> <span class="kn">import</span> <span class="n">LogLevel</span><span class="p">,</span> <span class="n">FBLoggerAdapter</span><span class="p">,</span> <span class="n">get_logger</span>

<div class="viewcode-block" id="TraceFlag"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.TraceFlag">[docs]</a><span class="k">class</span> <span class="nc">TraceFlag</span><span class="p">(</span><span class="n">IntFlag</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;`LoggingManager` trace/audit flags.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">NONE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ACTIVE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">BEFORE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">AFTER</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">FAIL</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span></div>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TracedItem</span><span class="p">(</span><span class="n">Distinct</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class method trace specification.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">decorator</span><span class="p">:</span> <span class="n">Callable</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Hashable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns Distinct key for traced item [method].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TracedClass</span><span class="p">(</span><span class="n">Distinct</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Traced class registry entry.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span>
    <span class="n">traced</span><span class="p">:</span> <span class="n">Registry</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">Registry</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Hashable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns Distinct key for traced item [cls].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>

<span class="n">_traced</span><span class="p">:</span> <span class="n">Registry</span> <span class="o">=</span> <span class="n">Registry</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">TracedMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Metaclass that instruments instances on creation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">trace_object</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="TracedMixin"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.TracedMixin">[docs]</a><span class="k">class</span> <span class="nc">TracedMixin</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">TracedMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mixin class that automatically registers descendants for trace and instruments</span>
<span class="sd">    instances on creation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">trace_manager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span></div>

<div class="viewcode-block" id="traced"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.traced">[docs]</a><span class="k">class</span> <span class="nc">traced</span><span class="p">:</span> <span class="c1"># pylint: disable=[R0902]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base decorator for logging of callables, suitable for trace/audit.</span>

<span class="sd">    It&#39;s not applied on decorated function/method if `FBASE_TRACE` environment variable is</span>
<span class="sd">    set to False, or if `FBASE_TRACE` is not defined and `__debug__` is False (optimized</span>
<span class="sd">    Python code).</span>

<span class="sd">    Both positional and keyword arguments of decorated callable are available by name for</span>
<span class="sd">    f-string type message interpolation as `dict` passed to logger as positional argument.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="traced.__init__"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.traced.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Any</span><span class="o">=</span><span class="n">DEFAULT</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Any</span><span class="o">=</span><span class="n">DEFAULT</span><span class="p">,</span> <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span>
                 <span class="n">msg_before</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="n">DEFAULT</span><span class="p">,</span> <span class="n">msg_after</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="n">DEFAULT</span><span class="p">,</span> <span class="n">msg_failed</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="n">DEFAULT</span><span class="p">,</span>
                 <span class="n">flags</span><span class="p">:</span> <span class="n">TraceFlag</span><span class="o">=</span><span class="n">TraceFlag</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">level</span><span class="p">:</span> <span class="n">LogLevel</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                 <span class="n">max_param_length</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="n">UNLIMITED</span><span class="p">,</span> <span class="n">extra</span><span class="p">:</span> <span class="n">Dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">has_result</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="n">DEFAULT</span><span class="p">,</span>
                 <span class="n">with_args</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arguments:</span>
<span class="sd">            agent: Agent identification</span>
<span class="sd">            context: Context identification</span>
<span class="sd">            topic: Trace/audit logging topic</span>
<span class="sd">            msg_before: Trace/audit message logged before decorated function</span>
<span class="sd">            msg_after: Trace/audit message logged after decorated function</span>
<span class="sd">            msg_failed: Trace/audit message logged when decorated function raises an exception</span>
<span class="sd">            flags: Trace flags override</span>
<span class="sd">            level: Logging level for trace/audit messages</span>
<span class="sd">            max_param_length: Max. length of parameters (longer will be trimmed)</span>
<span class="sd">            extra: Extra data for `LogRecord`</span>
<span class="sd">            callback: Callback function that gets the agent identification as argument,</span>
<span class="sd">               and must return True/False indicating whether trace is allowed.</span>
<span class="sd">            has_result: Indicator whether function has result value. If True, `_result_`</span>
<span class="sd">               is available for interpolation in `msg_after`. The `DEFAULT` value means,</span>
<span class="sd">               that value for this argument should be decided from function return value</span>
<span class="sd">               annotation.</span>
<span class="sd">            with_args: If True, function arguments are available for interpolation in</span>
<span class="sd">               `msg_before`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#: Trace/audit message logged before decorated function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_before</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">msg_before</span>
        <span class="c1">#: Trace/audit message logged after decorated function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_after</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">msg_after</span>
        <span class="c1">#: Trace/audit message logged when decorated function raises an exception</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_failed</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">msg_failed</span>
        <span class="c1">#: Agent identification</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">agent</span>
        <span class="c1">#: Context identification</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">context</span>
        <span class="c1">#: Trace/audit logging topic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">topic</span>
        <span class="c1">#: Trace flags override</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">:</span> <span class="n">TraceFlag</span> <span class="o">=</span> <span class="n">flags</span>
        <span class="c1">#: Logging level for trace/audit messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">:</span> <span class="n">LogLevel</span> <span class="o">=</span> <span class="n">level</span>
        <span class="c1">#: Max. length of parameters (longer will be trimmed)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">max_param_length</span>
        <span class="c1">#: Extra data for `LogRecord`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">extra</span>
        <span class="c1">#: Callback function that gets the agent identification as argument,</span>
        <span class="c1">#: and must return True/False indicating whether trace is allowed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__callback</span> <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">callback</span>
        <span class="c1">#: Indicator whether function has result value. If True, `_result_` is available</span>
        <span class="c1">#: for interpolation in `msg_after`.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_result</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">has_result</span>
        <span class="c1">#: If True, function arguments are available for interpolation in `msg_before`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_args</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">with_args</span></div>
    <span class="k">def</span> <span class="nf">__callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> <span class="c1"># pylint: disable=[W0613]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Default callback, does nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>
<div class="viewcode-block" id="traced.set_before_msg"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.traced.set_before_msg">[docs]</a>    <span class="k">def</span> <span class="nf">set_before_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">sig</span><span class="p">:</span> <span class="n">Signature</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the DEFAULT before message f-string template.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg_before</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; </span><span class="si">{</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1">=</span><span class="se">}}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;self&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg_before</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; </span><span class="si">{</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span></div>
<div class="viewcode-block" id="traced.set_after_msg"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.traced.set_after_msg">[docs]</a>    <span class="k">def</span> <span class="nf">set_after_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">sig</span><span class="p">:</span> <span class="n">Signature</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># pylint: disable=[W0613]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the DEFAULT after message f-string template.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_after</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;&lt;&lt; </span><span class="si">{</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">[</span><span class="se">{{</span><span class="s2">_etime_</span><span class="se">}}</span><span class="s2">] Result: </span><span class="se">{{</span><span class="s2">_result_</span><span class="se">}}</span><span class="s2">&quot;</span> \
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_result</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;&lt;&lt;&lt; </span><span class="si">{</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">[</span><span class="se">{{</span><span class="s2">_etime_</span><span class="se">}}</span><span class="s2">]&quot;</span></div>
<div class="viewcode-block" id="traced.set_fail_msg"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.traced.set_fail_msg">[docs]</a>    <span class="k">def</span> <span class="nf">set_fail_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">sig</span><span class="p">:</span> <span class="n">Signature</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># pylint: disable=[W0613]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the DEFAULT fail message f-string template.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_failed</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;-- </span><span class="si">{</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">[</span><span class="se">{{</span><span class="s2">_etime_</span><span class="se">}}</span><span class="s2">] </span><span class="se">{{</span><span class="s2">_exc_</span><span class="se">}}</span><span class="s2">&quot;</span></div>
<div class="viewcode-block" id="traced.log_before"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.traced.log_before">[docs]</a>    <span class="k">def</span> <span class="nf">log_before</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">FBLoggerAdapter</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Executed before decorated callable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_before</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>
<div class="viewcode-block" id="traced.log_after"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.traced.log_after">[docs]</a>    <span class="k">def</span> <span class="nf">log_after</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">FBLoggerAdapter</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Executed after decorated callable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_after</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>
<div class="viewcode-block" id="traced.log_failed"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.traced.log_failed">[docs]</a>    <span class="k">def</span> <span class="nf">log_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">FBLoggerAdapter</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Executed when decorated callable raises an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_failed</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span> <span class="c1"># pylint: disable=[R0915]</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="c1"># pylint: disable=[R0912]</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="n">trace_manager</span><span class="o">.</span><span class="n">flags</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span>
            <span class="k">if</span> <span class="n">enabled</span> <span class="o">:=</span> <span class="p">((</span><span class="n">TraceFlag</span><span class="o">.</span><span class="n">ACTIVE</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span> <span class="c1"># pylint: disable=[R1702]</span>
                <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">bound</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">bind_partial</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># If it&#39;s not a bound method, look for &#39;self&#39;</span>
                <span class="n">log</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="n">bound</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="ow">is</span> <span class="kc">None</span>
                                 <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">enabled</span> <span class="o">:=</span> <span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_args</span><span class="p">:</span>
                        <span class="n">bound</span><span class="o">.</span><span class="n">apply_defaults</span><span class="p">()</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bound</span><span class="o">.</span><span class="n">arguments</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">UNLIMITED</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">:</span>
                                    <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">]</span><span class="si">}</span><span class="s1">..[</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="si">}</span><span class="s1">]&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra</span><span class="p">)</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;_fname_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;_result_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1">#</span>
                    <span class="k">if</span> <span class="n">TraceFlag</span><span class="o">.</span><span class="n">BEFORE</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log_before</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">monotonic</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">enabled</span> <span class="ow">and</span> <span class="n">TraceFlag</span><span class="o">.</span><span class="n">FAIL</span> <span class="o">|</span> <span class="n">TraceFlag</span><span class="o">.</span><span class="n">ACTIVE</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;_etime_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">[:</span><span class="n">e</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;_exc_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log_failed</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">enabled</span> <span class="ow">and</span> <span class="n">TraceFlag</span><span class="o">.</span><span class="n">AFTER</span> <span class="o">|</span> <span class="n">TraceFlag</span><span class="o">.</span><span class="n">ACTIVE</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;_etime_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">[:</span><span class="n">e</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_result</span><span class="p">:</span>
                        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;_result_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">UNLIMITED</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">:</span>
                                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;_result_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">]</span><span class="si">}</span><span class="s1">..[</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="si">}</span><span class="s1">]&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log_after</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">trace</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;FBASE_TRACE&#39;</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">convert_from_str</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">fn</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fn</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="ow">is</span> <span class="n">DEFAULT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;__self__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_result</span> <span class="ow">is</span> <span class="n">DEFAULT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_result</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">return_annotation</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_before</span> <span class="ow">is</span> <span class="n">DEFAULT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_before_msg</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_after</span> <span class="ow">is</span> <span class="n">DEFAULT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_after_msg</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_failed</span> <span class="ow">is</span> <span class="n">DEFAULT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_fail_msg</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span></div>


<div class="viewcode-block" id="BaseTraceConfig"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.BaseTraceConfig">[docs]</a><span class="k">class</span> <span class="nc">BaseTraceConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span> <span class="c1"># pylint: disable=[R0902]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base configuration for trace.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="c1">#: Agent identification</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">:</span> <span class="n">StrOption</span> <span class="o">=</span> \
            <span class="n">StrOption</span><span class="p">(</span><span class="s1">&#39;agent&#39;</span><span class="p">,</span> <span class="s2">&quot;Agent identification&quot;</span><span class="p">)</span>
        <span class="c1">#: Context identification</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">:</span> <span class="n">StrOption</span> <span class="o">=</span> \
            <span class="n">StrOption</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="s2">&quot;Context identification&quot;</span><span class="p">)</span>
        <span class="c1">#: Trace/audit logging topic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="p">:</span> <span class="n">StrOption</span> <span class="o">=</span> \
            <span class="n">StrOption</span><span class="p">(</span><span class="s1">&#39;topic&#39;</span><span class="p">,</span> <span class="s2">&quot;Trace/audit logging topic&quot;</span><span class="p">)</span>
        <span class="c1">#: Trace/audit message logged before decorated function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_before</span><span class="p">:</span> <span class="n">StrOption</span> <span class="o">=</span> \
            <span class="n">StrOption</span><span class="p">(</span><span class="s1">&#39;msg_before&#39;</span><span class="p">,</span> <span class="s2">&quot;Trace/audit message logged before decorated function&quot;</span><span class="p">)</span>
        <span class="c1">#: Trace/audit message logged after decorated function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_after</span><span class="p">:</span> <span class="n">StrOption</span> <span class="o">=</span> \
            <span class="n">StrOption</span><span class="p">(</span><span class="s1">&#39;msg_after&#39;</span><span class="p">,</span> <span class="s2">&quot;Trace/audit message logged after decorated function&quot;</span><span class="p">)</span>
        <span class="c1">#: Trace/audit message logged when decorated function raises an exception</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_failed</span><span class="p">:</span> <span class="n">StrOption</span> <span class="o">=</span> \
            <span class="n">StrOption</span><span class="p">(</span><span class="s1">&#39;msg_failed&#39;</span><span class="p">,</span> <span class="s2">&quot;Trace/audit message logged when decorated function raises an exception&quot;</span><span class="p">)</span>
        <span class="c1">#: Trace flags override</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">:</span> <span class="n">FlagOption</span> <span class="o">=</span> \
            <span class="n">FlagOption</span><span class="p">(</span><span class="s1">&#39;flags&#39;</span><span class="p">,</span> <span class="n">TraceFlag</span><span class="p">,</span> <span class="s2">&quot;Trace flags override&quot;</span><span class="p">)</span>
        <span class="c1">#: Logging level for trace/audit messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">:</span> <span class="n">EnumOption</span> <span class="o">=</span> \
            <span class="n">EnumOption</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="n">LogLevel</span><span class="p">,</span> <span class="s2">&quot;Logging level for trace/audit messages&quot;</span><span class="p">)</span>
        <span class="c1">#: Max. length of parameters (longer will be trimmed)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_param_length</span><span class="p">:</span> <span class="n">IntOption</span> <span class="o">=</span> \
            <span class="n">IntOption</span><span class="p">(</span><span class="s1">&#39;max_param_length&#39;</span><span class="p">,</span> <span class="s2">&quot;Max. length of parameters (longer will be trimmed)&quot;</span><span class="p">)</span>
        <span class="c1">#: Indicator whether function has result value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_result</span><span class="p">:</span> <span class="n">BoolOption</span> <span class="o">=</span> \
            <span class="n">BoolOption</span><span class="p">(</span><span class="s1">&#39;has_result&#39;</span><span class="p">,</span> <span class="s2">&quot;Indicator whether function has result value&quot;</span><span class="p">)</span>
        <span class="c1">#: If True, function arguments are available for interpolation in `msg_before`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_args</span><span class="p">:</span> <span class="n">BoolOption</span> <span class="o">=</span> \
            <span class="n">BoolOption</span><span class="p">(</span><span class="s1">&#39;with_args&#39;</span><span class="p">,</span>
                       <span class="s2">&quot;If True, function arguments are available for interpolation in `msg_before`&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TracedMethodConfig"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.TracedMethodConfig">[docs]</a><span class="k">class</span> <span class="nc">TracedMethodConfig</span><span class="p">(</span><span class="n">BaseTraceConfig</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration of traced Python method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="c1">#: Class method name [required]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">:</span> <span class="n">StrOption</span> <span class="o">=</span> \
            <span class="n">StrOption</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s2">&quot;Class method name&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TracedClassConfig"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.TracedClassConfig">[docs]</a><span class="k">class</span> <span class="nc">TracedClassConfig</span><span class="p">(</span><span class="n">BaseTraceConfig</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration of traced Python class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="c1">#: Fully qualified class name [required]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span> <span class="n">StrOption</span> <span class="o">=</span> \
            <span class="n">StrOption</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s2">&quot;Fully qualified class name&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#: Names of traced class methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">:</span> <span class="n">ListOption</span> <span class="o">=</span> \
            <span class="n">ListOption</span><span class="p">(</span><span class="s1">&#39;methods&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Names of traced class methods&quot;</span><span class="p">)</span>
        <span class="c1">#: Configuration sections with extended config of traced class methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">special</span><span class="p">:</span> <span class="n">ConfigListOption</span> <span class="o">=</span> \
            <span class="n">ConfigListOption</span><span class="p">(</span><span class="s1">&#39;special&#39;</span><span class="p">,</span>
                             <span class="s2">&quot;Configuration sections with extended config of traced class methods&quot;</span><span class="p">,</span>
                             <span class="n">TracedMethodConfig</span><span class="p">)</span>
        <span class="c1">#: Wherher configuration should be applied also to all registered descendant classes [default: True].</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_descendants</span><span class="p">:</span> <span class="n">BoolOption</span> <span class="o">=</span> \
            <span class="n">BoolOption</span><span class="p">(</span><span class="s1">&#39;apply_to_descendants&#39;</span><span class="p">,</span>
                       <span class="s2">&quot;Configuration should be applied also to all registered descendant classes&quot;</span><span class="p">,</span>
                       <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TraceConfig"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.TraceConfig">[docs]</a><span class="k">class</span> <span class="nc">TraceConfig</span><span class="p">(</span><span class="n">BaseTraceConfig</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Trace manager configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="c1">#: When True, unregistered classes are registered automatically [default: True].</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autoregister</span><span class="p">:</span> <span class="n">BoolOption</span> <span class="o">=</span> \
            <span class="n">BoolOption</span><span class="p">(</span><span class="s1">&#39;autoregister&#39;</span><span class="p">,</span>
                       <span class="s2">&quot;When True, unregistered classes are registered automatically&quot;</span><span class="p">,</span>
                       <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#: Configuration sections with traced Python classes [required].</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span> <span class="n">ConfigListOption</span> <span class="o">=</span> \
            <span class="n">ConfigListOption</span><span class="p">(</span><span class="s1">&#39;classes&#39;</span><span class="p">,</span>
                             <span class="s2">&quot;Configuration sections with traced Python classes&quot;</span><span class="p">,</span>
                             <span class="n">TracedClassConfig</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TraceManager"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.TraceManager">[docs]</a><span class="k">class</span> <span class="nc">TraceManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Trace manager.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#: Decorator that should be used for trace instrumentation (via `add_trace`),</span>
        <span class="c1">#: default: `traced`.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decorator</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">traced</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_traced</span><span class="p">:</span> <span class="n">Registry</span> <span class="o">=</span> <span class="n">Registry</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span><span class="p">:</span> <span class="n">TraceFlag</span> <span class="o">=</span> <span class="n">TraceFlag</span><span class="o">.</span><span class="n">NONE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace_active</span> <span class="o">=</span> <span class="n">convert_from_str</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;FBASE_TRACE&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">__debug__</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">convert_from_str</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;FBASE_TRACE_BEFORE&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">)):</span> <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_flag</span><span class="p">(</span><span class="n">TraceFlag</span><span class="o">.</span><span class="n">BEFORE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">convert_from_str</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;FBASE_TRACE_AFTER&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">)):</span> <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_flag</span><span class="p">(</span><span class="n">TraceFlag</span><span class="o">.</span><span class="n">AFTER</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">convert_from_str</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;FBASE_TRACE_FAIL&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_flag</span><span class="p">(</span><span class="n">TraceFlag</span><span class="o">.</span><span class="n">FAIL</span><span class="p">)</span>
<div class="viewcode-block" id="TraceManager.is_registered"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.TraceManager.is_registered">[docs]</a>    <span class="k">def</span> <span class="nf">is_registered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if class is registered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traced</span></div>
<div class="viewcode-block" id="TraceManager.clear"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.TraceManager.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes all trace specifications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traced</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">traced</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>
<div class="viewcode-block" id="TraceManager.register"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.TraceManager.register">[docs]</a>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register class for trace.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            cls: Class to be registered.</span>

<span class="sd">        Does nothing if class is already registered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traced</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_traced</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">TracedClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">))</span></div>
<div class="viewcode-block" id="TraceManager.add_trace"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.TraceManager.add_trace">[docs]</a>    <span class="k">def</span> <span class="nf">add_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">/</span> <span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add/update trace specification for class method.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            cls: Registered traced class</span>
<span class="sd">            method: Name of class method that should be instrumented for trace</span>
<span class="sd">            args: Positional arguments for decorator</span>
<span class="sd">            kwargs: Keyword arguments for decorator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_traced</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span><span class="o">.</span><span class="n">traced</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TracedItem</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decorator</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span></div>
<div class="viewcode-block" id="TraceManager.remove_trace"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.TraceManager.remove_trace">[docs]</a>    <span class="k">def</span> <span class="nf">remove_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove trace specification for class method.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            cls: Registered traced class</span>
<span class="sd">            method: Name of class method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traced</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span><span class="o">.</span><span class="n">traced</span><span class="p">[</span><span class="n">method</span><span class="p">]</span></div>
<div class="viewcode-block" id="TraceManager.trace_object"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.TraceManager.trace_object">[docs]</a>    <span class="k">def</span> <span class="nf">trace_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instruments object&#39;s methods with decorator according to trace configuration.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            strict: Determines the response if the object class is not registered for trace.</span>
<span class="sd">                    Raises exception when True, or return the instance as is when False [default].</span>

<span class="sd">        Only methods registered with `.add_trace()` are instrumented.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Decorated instance.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: When object class is not registered and `strict` is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">trace</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;FBASE_TRACE&#39;</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">convert_from_str</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">obj</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="n">entry</span><span class="p">:</span> <span class="n">TracedClass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traced</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Class &#39;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; not registered for trace!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">traced</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">decorator</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">item</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">method</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">obj</span></div>
<div class="viewcode-block" id="TraceManager.load_config"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.TraceManager.load_config">[docs]</a>    <span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigParser</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update trace from configuration.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            config:  ConfigParser instance with trace configuration.</span>
<span class="sd">            section: Name of ConfigParser section that should be used to get trace</span>
<span class="sd">                     configuration.</span>

<span class="sd">        Uses `.TraceConfig`, `.TracedClassConfig` and `.TracedMethodConfig` to process</span>
<span class="sd">        the configuration.</span>

<span class="sd">        Note:</span>
<span class="sd">            Does not `.clear()` existing trace specifications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">build_kwargs</span><span class="p">(</span><span class="n">from_cfg</span><span class="p">:</span> <span class="n">BaseTraceConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;agent&#39;</span><span class="p">,</span> <span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="s1">&#39;topic&#39;</span><span class="p">,</span> <span class="s1">&#39;msg_before&#39;</span><span class="p">,</span> <span class="s1">&#39;msg_after&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;msg_failed&#39;</span><span class="p">,</span> <span class="s1">&#39;flags&#39;</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="s1">&#39;max_param_length&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;has_result&#39;</span><span class="p">,</span> <span class="s1">&#39;with_args&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">:=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">from_cfg</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">def</span> <span class="nf">apply_on</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">items</span> <span class="o">:=</span> <span class="n">cls_cfg</span><span class="o">.</span><span class="n">methods</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isfunction</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">i</span><span class="p">))]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="o">*</span><span class="p">[],</span> <span class="o">**</span><span class="n">cls_kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">items</span> <span class="o">:=</span> <span class="n">cls_cfg</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">mcfg</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="n">mcfg</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">value</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cls_kwargs</span><span class="p">)</span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">build_kwargs</span><span class="p">(</span><span class="n">mcfg</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">with_name</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">==</span> <span class="n">name</span>

        <span class="n">cfg</span> <span class="o">=</span> <span class="n">TraceConfig</span><span class="p">(</span><span class="s1">&#39;trace&#39;</span><span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">value</span>
        <span class="n">global_kwargs</span> <span class="o">=</span> <span class="n">build_kwargs</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cls_cfg</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">cls_name</span> <span class="o">=</span> <span class="n">cls_cfg</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">value</span>
            <span class="n">cls_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">cls_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">global_kwargs</span><span class="p">)</span>
            <span class="n">cls_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">build_kwargs</span><span class="p">(</span><span class="n">cls_cfg</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cls_desc</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traced</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">with_name</span><span class="p">,</span> <span class="n">cls_name</span><span class="p">)))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">autoregister</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="bp">cls</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cls_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Class &#39;</span><span class="si">{</span><span class="n">cls_name</span><span class="si">}</span><span class="s2">&#39; is not registered for trace.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="n">cls_desc</span><span class="o">.</span><span class="n">cls</span>
            <span class="n">apply_on</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cls_cfg</span><span class="o">.</span><span class="n">apply_to_descendants</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cls_desc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traced</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cls_desc</span><span class="o">.</span><span class="n">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">cls</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">cls_desc</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
                        <span class="n">apply_on</span><span class="p">(</span><span class="n">cls_desc</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span></div>
<div class="viewcode-block" id="TraceManager.set_flag"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.TraceManager.set_flag">[docs]</a>    <span class="k">def</span> <span class="nf">set_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">:</span> <span class="n">TraceFlag</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set flag specified by `flag` mask.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">flag</span></div>
<div class="viewcode-block" id="TraceManager.clear_flag"><a class="viewcode-back" href="../../../trace.html#firebird.base.trace.TraceManager.clear_flag">[docs]</a>    <span class="k">def</span> <span class="nf">clear_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">:</span> <span class="n">TraceFlag</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear flag specified by `flag` mask.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">flag</span></div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">flags</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TraceFlag</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trace flags.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span>
    <span class="nd">@flags</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">TraceFlag</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span> <span class="o">=</span> <span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">TraceFlag</span><span class="p">)</span> <span class="k">else</span> <span class="n">TraceFlag</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">trace_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True if trace is active.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TraceFlag</span><span class="o">.</span><span class="n">ACTIVE</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span>
    <span class="nd">@trace_active</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">trace_active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">TraceFlag</span><span class="o">.</span><span class="n">ACTIVE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TraceFlag</span><span class="o">.</span><span class="n">ACTIVE</span></div>

<span class="c1">#: Trace manager</span>
<span class="n">trace_manager</span><span class="p">:</span> <span class="n">TraceManager</span> <span class="o">=</span> <span class="n">TraceManager</span><span class="p">()</span>

<span class="c1">#: shortcut for `trace_manager.add_trace()`</span>
<span class="n">add_trace</span> <span class="o">=</span> <span class="n">trace_manager</span><span class="o">.</span><span class="n">add_trace</span>
<span class="c1">#: shortcut for `trace_manager.remove_trace()`</span>
<span class="n">remove_trace</span> <span class="o">=</span> <span class="n">trace_manager</span><span class="o">.</span><span class="n">remove_trace</span>
<span class="c1">#: shortcut for `trace_manager.trace_object()`</span>
<span class="n">trace_object</span> <span class="o">=</span> <span class="n">trace_manager</span><span class="o">.</span><span class="n">trace_object</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2020-2023, The Firebird Project.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 6.1.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>